---
import CategoryCard from './CategoryCard.astro';

export interface Props {
  categories: any[];
  title?: string;
  subtitle?: string;
  disableLinks?: boolean;
}

const {
  categories = [],
  title,
  subtitle,
  disableLinks = false
} = Astro.props;

const categoryItems = Array.isArray(categories) ? categories : [];

function getCategoryType(category: any): string {
  return String(category?.id || 'general').trim().toLowerCase();
}
---

<div class="w-full" data-categories-carousel>
  <div class="w-full max-w-[1400px] mx-auto px-3 sm:px-4 md:px-6 lg:px-8 xl:px-10">
    <div class="categories-carousel relative">
      <div class="categories-carousel-container w-full overflow-hidden px-[6px] mx-[-6px] box-content">
        <div
          class="categories-carousel-track flex items-stretch py-[6px]"
          id="categoriesTrackDesktop"
        >
          {categoryItems.map((category, index) => (
            <div
              class="category-slide flex-shrink-0"
              data-index={index}
              data-category={getCategoryType(category)}
            >
              <CategoryCard
                id={category.id}
                title={category.title}
                description={category.description}
                image={category.image}
                gradient={category.gradient}
                url={category.url}
                clickable={!disableLinks}
              />
            </div>
          ))}
        </div>
      </div>

      <div class="carousel-controls flex justify-center items-center gap-3 mt-4 sm:mt-5 lg:mt-7">
        <button
          class="carousel-prev bg-white text-pink p-2 sm:p-2.5 rounded-full shadow-lg z-10 hover:bg-gray-100 transition-colors"
          aria-label="Anterior"
          id="prevBtnDesktop"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <div class="carousel-dots flex gap-2"></div>
        <button
          class="carousel-next bg-white text-pink p-2 sm:p-2.5 rounded-full shadow-lg z-10 hover:bg-gray-100 transition-colors"
          aria-label="Siguiente"
          id="nextBtnDesktop"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>

    </div>
  </div>
</div>

<style>
  .categories-carousel-track {
    flex-wrap: nowrap;
    transition: transform 0.35s ease;
  }
  .category-slide {
    flex-shrink: 0;
  }
</style>

<script>
  function initCategoriesCarousel(root) {
    if (!root || root.dataset.ccInitialized === 'true') return;
    root.dataset.ccInitialized = 'true';

    const track         = root.querySelector('#categoriesTrackDesktop');
    const prevBtn       = root.querySelector('#prevBtnDesktop');
    const nextBtn       = root.querySelector('#nextBtnDesktop');
    const dotsContainer = root.querySelector('.carousel-dots');
    const controls      = root.querySelector('.carousel-controls');
    const outerWrap     = root.querySelector('.categories-carousel-container');

    if (!track || !prevBtn || !nextBtn || !dotsContainer || !controls || !outerWrap) return;

    const slides = Array.from(track.querySelectorAll('.category-slide'));
    let currentSlide = 0;

    /* ─── breakpoints ───── */

    function getSlidesPerView() {
      const w = window.innerWidth;
      if (w < 480)  return 1;
      if (w < 1024) return 2;
      if (w < 1280) return 3;
      return 4;
    }

    function getGap() {
      const w = window.innerWidth;
      if (w < 480)  return 12;
      if (w < 768)  return 14;
      if (w < 1024) return 16;
      if (w < 1280) return 18;
      return 20;
    }

    function slideWidth() {
      const spv = Math.min(getSlidesPerView(), slides.length);
      const gap = getGap();
      const cw  = outerWrap.offsetWidth - 12;
      return (cw - gap * (spv - 1)) / spv;
    }

    function applySlideWidths() {
      const sw  = slideWidth();
      const gap = getGap();
      track.style.gap = gap + 'px';
      slides.forEach(s => {
        s.style.width    = sw + 'px';
        s.style.minWidth = sw + 'px';
        s.style.maxWidth = sw + 'px';
      });
    }

    function needsCarousel() {
      return slides.length > getSlidesPerView();
    }

    function maxSlide() {
      return Math.max(0, slides.length - getSlidesPerView());
    }

    /* ─── navegación ───────── */

    function goTo(index) {
      currentSlide = Math.max(0, Math.min(index, maxSlide()));
      const offset = currentSlide * (slideWidth() + getGap());
      track.style.transform = `translateX(-${offset}px)`;
      updateDots();
      updateButtons();
    }

    /* ─── dots ───────── */

    function buildDots() {
      dotsContainer.innerHTML = '';
      if (!needsCarousel()) return;
      const totalDots = maxSlide() + 1;
      for (let i = 0; i < totalDots; i++) {
        const dot = document.createElement('button');
        dot.className = 'w-3 h-3 rounded-full transition-colors duration-200 ' +
          (i === currentSlide ? 'bg-pink' : 'bg-gray-300');
        dot.setAttribute('aria-label', `Ir a slide ${i + 1}`);
        dot.addEventListener('click', () => goTo(i));
        dotsContainer.appendChild(dot);
      }
    }

    function updateDots() {
      Array.from(dotsContainer.querySelectorAll('button')).forEach((dot, i) => {
        dot.classList.toggle('bg-pink',      i === currentSlide);
        dot.classList.toggle('bg-gray-300',  i !== currentSlide);
      });
    }

    /* ─── botones ─────── */

    function updateButtons() {
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide >= maxSlide();
      prevBtn.classList.toggle('opacity-40',         prevBtn.disabled);
      prevBtn.classList.toggle('cursor-not-allowed', prevBtn.disabled);
      nextBtn.classList.toggle('opacity-40',         nextBtn.disabled);
      nextBtn.classList.toggle('cursor-not-allowed', nextBtn.disabled);
    }

    function refresh() {
      if (currentSlide > maxSlide()) currentSlide = maxSlide();

      applySlideWidths();

      track.style.flexWrap       = 'nowrap';
      track.style.justifyContent = 'flex-start';

      if (needsCarousel()) {
        controls.style.display = 'flex';
        buildDots();
        goTo(currentSlide);
      } else {
        controls.style.display = 'none';
        track.style.transform  = 'translateX(0px)';
      }
    }

    /* ─── eventos ────── */

    prevBtn.addEventListener('click', () => goTo(currentSlide - 1));
    nextBtn.addEventListener('click', () => goTo(currentSlide + 1));

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(refresh, 120);
    });

    refresh();
  }

  function initAll() {
    document.querySelectorAll('[data-categories-carousel]').forEach(initCategoriesCarousel);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
  document.addEventListener('astro:page-load',  initAll);
  document.addEventListener('astro:after-swap', initAll);
</script>