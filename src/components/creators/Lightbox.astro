---
// src/components/creators/Lightbox.astro
---

<div id="creator-lightbox" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[2147483647] isolate flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 p-2 md:p-4">
  <!-- Contenedor del contenido -->
  <div id="lightbox-content" class="relative w-[95%] lg:w-full h-[90vh] max-w-6xl bg-orange rounded-lg shadow-xl transform scale-95 transition-all duration-300 flex flex-col md:flex-row overflow-hidden">
    <!-- Botón de cerrar -->
    <button id="lightbox-close" class="absolute top-2 right-2 md:-top-4 md:-right-4 bg-white text-black rounded-full h-10 w-10 flex items-center justify-center z-10 shadow-lg">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>

    <!-- Contenedor de medios (imagen o video) -->
    <div id="media-container" class="flex-1 bg-black rounded-t-lg md:rounded-l-lg md:rounded-tr-none overflow-hidden flex items-center justify-center min-h-[50vh] md:min-h-0">
      <!-- El contenido se insertará aquí dinámicamente -->
    </div>

    <!-- Información del post -->
    <div class="w-full md:w-80 p-4 md:p-6 flex flex-col justify-center overflow-y-auto">
      <p id="lightbox-description" class="text-white text-lg md:text-2xl mb-3 md:mb-4 leading-relaxed"></p>
      <p id="lightbox-author" class="text-white/70 text-lg md:text-2xl mb-2 md:mb-3"></p>
      <div id="lightbox-country" class="text-white/60 text-lg md:text-2xl mb-2"></div>
      <div id="lightbox-categories" class="flex flex-wrap gap-2"></div>
    </div>
  </div>
</div>

<script>
  // Función para obtener información del país
  function getCountryDisplayInfo(countryCode) {
    const countries = {
      'guatemala': { name: 'Guatemala', flag: '🇬🇹' },
      'honduras': { name: 'Honduras', flag: '🇭🇳' },
      'el_salvador': { name: 'El Salvador', flag: '🇸🇻' },
      'nicaragua': { name: 'Nicaragua', flag: '🇳🇮' },
      'costa_rica': { name: 'Costa Rica', flag: '🇨🇷' },
      'republica_dominicana': { name: 'República Dominicana', flag: '🇩🇴' }
    };
    
    return countries[countryCode] || { name: countryCode, flag: '🌍' };
  }

  document.addEventListener('astro:page-load', () => {
    const lightbox = document.getElementById('creator-lightbox');
    const content = document.getElementById('lightbox-content');
    const closeButton = document.getElementById('lightbox-close');
    const mediaContainer = document.getElementById('media-container');
    const descriptionEl = document.getElementById('lightbox-description');
    const authorEl = document.getElementById('lightbox-author');
    const countryEl = document.getElementById('lightbox-country');
    const categoriesEl = document.getElementById('lightbox-categories');

    if (!lightbox || !closeButton || !mediaContainer || !descriptionEl || !authorEl || !countryEl || !categoriesEl || !content) return;

    const openLightbox = (detail) => {
      if (!detail || !detail.src) return;

      // Limpiar contenido anterior
      mediaContainer.innerHTML = '';

      if (detail.type === 'video') {
        const video = document.createElement('video');
        video.src = detail.src;
        video.controls = true;
        video.autoplay = true;
        video.playsInline = true;
        video.className = 'w-full h-full object-contain';
        mediaContainer.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = detail.src;
        img.className = 'w-full h-full object-contain';
        mediaContainer.appendChild(img);
      }

      descriptionEl.textContent = detail.description || '';
      authorEl.textContent = detail.author ? `Por: @${detail.author}` : '';
      
      // Mostrar país
      if (detail.country) {
        const countryInfo = getCountryDisplayInfo(detail.country);
        countryEl.innerHTML = `<span class="inline-flex items-center gap-1"><span>${countryInfo.flag}</span><span>${countryInfo.name}</span></span>`;
      } else {
        countryEl.innerHTML = '';
      }
      
      // Mostrar categorías
      categoriesEl.innerHTML = '';
      if (detail.categories && detail.categories.length > 0) {
        detail.categories.forEach(category => {
          const categoryTag = document.createElement('span');
          categoryTag.className = 'bg-white/20 text-white text-sm md:text-2xl px-2 md:px-3 py-1 md:py-2 rounded-full';
          categoryTag.textContent = category;
          categoriesEl.appendChild(categoryTag);
        });
      }

      lightbox.classList.remove('opacity-0', 'pointer-events-none');
      content.classList.remove('scale-95');

      // Lock page scroll while lightbox is open
      try {
        document.documentElement.classList.add('overflow-hidden');
        document.body.classList.add('overflow-hidden');
      } catch (_) { /* noop */ }
    };

    const closeLightbox = () => {
      lightbox.classList.add('opacity-0', 'pointer-events-none');
      content.classList.add('scale-95');
      // Unlock page scroll
      try {
        document.documentElement.classList.remove('overflow-hidden');
        document.body.classList.remove('overflow-hidden');
      } catch (_) { /* noop */ }
      // Detener video si existe
      const video = mediaContainer.querySelector('video');
      if (video) {
        video.pause();
        video.src = '';
      }
    };

    // Event listener para abrir
    document.addEventListener('show-lightbox', (e) => {
      openLightbox(e.detail);
    });

    // Event listeners para cerrar
    closeButton.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) { // Cierra solo si se hace clic en el fondo
        closeLightbox();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLightbox();
      }
    });
  });
</script>
