---
// src/pages/[lang]/[pageSlug].astro
import { routesConfig, findRouteBySlug } from '../../config/routes';
import { setLocale, t, type Locale } from '../../i18n/i18n';
import MainLayout from '../../layouts/MainLayout.astro';
import RecipeDetail from '../../views/Recipes/Detail/index.astro';

// Define the expected structure of the dynamically imported modules
interface PageModule {
  default: any; // Using 'any' for simplicity with dynamic Astro component imports
}

// Obtener todos los posibles componentes de contenido de página
// La ruta para Astro.glob debe ser relativa desde este archivo o absoluta desde el proyecto.
// Usaremos una ruta que asume que los componentes están en src/views/*/index.astro
const pageComponents = await Astro.glob('../../views/*/index.astro');

export async function getStaticPaths() {
  const paths = [];
  for (const route of routesConfig) {
    if (route.id === 'home') continue; // La página de inicio se maneja en [lang]/index.astro

    for (const lang in route.slugs) {
      paths.push({
        params: { lang, pageSlug: route.slugs[lang] },
        props: { routeId: route.id }
      });
    }
  }
  return paths;
}

const { lang, pageSlug } = Astro.params as { lang: Locale; pageSlug: string };
const { routeId } = Astro.props as { routeId: string };

setLocale(lang);

// Variables para el renderizado condicional
let isRecipeDetail = false;
let recipeData = null;
let recipeId = '';
let langCode = '';

// Verificar si es una ruta de detalle de receta
// Formato: /es/recetas/[id] o /en/recipes/[id]
if (Astro.url.pathname.split('/').filter(Boolean).length === 3) {
  langCode = Astro.url.pathname.split('/').filter(Boolean)[0];
  const section = Astro.url.pathname.split('/').filter(Boolean)[1];
  const detailId = Astro.url.pathname.split('/').filter(Boolean)[2];
  
  // Verificar si es una ruta de recetas
  const isRecipesRoute = 
    (langCode === 'es' && section === 'recetas') || 
    (langCode === 'en' && section === 'recipes');
  
  if (isRecipesRoute) {
    try {
      // Cargar datos de recetas directamente
      const allRecipes = t('items', { namespace: 'recipes', locale: langCode as Locale }) || [];
      
      const recipe = allRecipes.find((r: any) => r.id === detailId);
      
      if (recipe) {
        // Preparar datos para renderizado en la sección de plantilla
        isRecipeDetail = true;
        recipeData = recipe;
        recipeId = detailId;
      } else {
        return Astro.redirect(`/${langCode}/404`);
      }
    } catch (error) {
      return Astro.redirect(`/${langCode}/404`);
    }
  }
}

// Si no es una receta, seguir con el flujo normal de páginas
let pageTitle = '';
let pageDescription = '';
let ContentComponent;

if (!isRecipeDetail) {
  // Obtener la ruta actual para páginas normales
  const currentRoute = findRouteBySlug(lang, pageSlug);

  // Si no es una ruta de detalle o no se encontró la receta, seguir con el flujo normal
  if (!currentRoute) {
    return Astro.redirect(`/${lang}/404`);
  }

  // Usar import.meta.glob()
  // Esto devuelve un objeto donde las claves son las rutas y los valores son funciones para importar el módulo.
  const modules = import.meta.glob('../../views/*/index.astro');

  // Transformar la ruta del contentComponent para que coincida con las claves de import.meta.glob()
  // Asumimos que [pageSlug].astro está en src/pages/[lang]/ y los componentes en src/components/pages/
  // Por lo tanto, '@/' se traduce a '../../' desde la perspectiva de [pageSlug].astro para llegar a la raíz de src/
  const targetModulePath = currentRoute.contentComponent.replace('@/', '../../');

  const moduleLoader = modules[targetModulePath]; // modules es Record<string, () => Promise<any>>

  if (!moduleLoader) {
    return Astro.redirect(`/${lang}/404`);
  }

  const loadedModule = await moduleLoader(); // Ejecutar la función para cargar el módulo
  const ContentComponentModule = loadedModule as PageModule; // Explicitly cast to PageModule
  ContentComponent = ContentComponentModule.default;

  if (!ContentComponent) {
    return Astro.redirect(`/${lang}/404`);
  }

  pageTitle = currentRoute.metaTitleKey ? t(currentRoute.metaTitleKey) : 'Page';
  pageDescription = currentRoute.metaDescriptionKey ? t(currentRoute.metaDescriptionKey) : '';
}
---

{isRecipeDetail && (
  <MainLayout title={recipeData.title ?? ''} description="">
    <RecipeDetail currentLang={langCode as Locale} recipeId={recipeId} />
  </MainLayout>
)}

{!isRecipeDetail && (
  <MainLayout title={pageTitle} description={pageDescription}>
    <ContentComponent />
  </MainLayout>
)}
