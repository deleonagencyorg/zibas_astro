<!-- src/views/Home/index.astro -->
---
import LazyImage from '../../components/common/LazyImage.astro';
// Component Imports
import VideoCarousel from '../../components/common/VideoCarousel/index.astro';
import RecipesCarousel from "../../components/recipes/RecipesCarousel.astro";
import ProductsCarousel from '../../components/common/ProductsCarousel/index.astro';
import MasonryGallery from '../../components/gallery/MasonryGallery.astro';
import PixelGrid from '../../components/atoms/PixelGrid.astro';
import BlogCard from '../../components/blog/BlogCard.astro';


// Style Imports
import './styles.css';

// i18n and Data Imports
import { t, getLocale } from '../../i18n/i18n';
import { InstagramEmbed } from 'react-social-media-embed';



// Props
export interface Props {
  loading?: boolean;
}
const { loading = false } = Astro.props;

// Language and Data Setup
const currentLang = getLocale();
const homeAssets = t('home', { namespace: 'common', locale: currentLang }) || {};
const recipesAssets = t('', { namespace: 'recipes', locale: currentLang }) || {};
const galleryAssets = t('', { namespace: 'gallery', locale: currentLang }) || {};
const aboutAssets = t('', { namespace: 'aboutus', locale: currentLang }) || {};
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang }) || [];
const brandsList = brandsAssets.brands || [];
const zibasBrand = brandsList.find((brand: any) => brand.id === 'zibas');
const zibasProducts = zibasBrand?.products || [];

const commonAssets = t('assets.slider', { namespace: 'common', locale: currentLang }) || [];
const slides = Array.isArray(commonAssets)
  ? commonAssets
    .filter(asset => asset && typeof asset === 'object' && asset.desktop && asset.mobile)
    .map(asset => ({
      desktop: asset.desktop,
      mobile: asset.mobile,
      alt: asset.alt || "Ziba's",
      type: asset.type || '',
      preview: asset.preview || '',
      title: asset.title || '',
      subtitle: asset.description || '',
      link: asset.url || asset.link || ''
    }))
  : [];

// Load latest blog posts by current language from markdown
const blogModules = import.meta.glob('../../locales/*/blog/*.md');
let latestBlogPosts: Array<{ id: string; slug: string; title: string; image?: string; published_date?: string; }>= [];
for (const path in blogModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const mod: any = await blogModules[path]();
    const fm = mod.frontmatter || {};
    if (fm && fm.id && fm.slug && fm.title) {
      latestBlogPosts.push({
        id: String(fm.id),
        slug: String(fm.slug),
        title: String(fm.title),
        image: fm.image ? String(fm.image) : '/images/blog/placeholder.jpg',
        published_date: fm.published_date ? String(fm.published_date) : ''
      });
    }
  }
}
function toDate(s?: string){
  if(!s) return 0; 
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,(m||1)-1,d||1).getTime(); }
  const t=Date.parse(s); return isNaN(t)?0:t;
}
latestBlogPosts = latestBlogPosts.sort((a,b)=> toDate(b.published_date)-toDate(a.published_date)).slice(0,5);
const noNewsText = currentLang==='es' ? 'Entérate de nuestras últimas novedades en experiencias, sabores y más.' : 'Stay updated on our latest news in experiences, flavors, and more.';
const topNewsLabel = currentLang==='es' ? 'NOTICIAS MÁS IMPORTANTES' : 'TOP NEWS';
const featuredLabel = currentLang==='es' ? 'DESTACADOS' : 'FEATURED';

---

  <main class="w-full flex flex-col items-center justify-center mt-0">
    <!-- Slider Section con VideoCarousel -->
    <div class="relative w-full overflow-hidden">
      <VideoCarousel 
        slides={slides} 
        height="100vh" 
        mobileHeight="300px" 
        showOverlay={true} 
      />
    </div>
    
    <!-- Sección de Productos Zibas -->
    {zibasProducts.length > 0 && (
      <section id="products" class="w-full py-4 bg-blue pt-16">
        <div class="container mx-auto px-4">
          {brandsAssets.home?.title && (
          <div class="text-center mb-2 relative z-20" >
            <h2 class="text-3xl md:text-4xl italic font-bold mb-3" style={`color: white`}>
              {brandsAssets.home?.title}
            </h2>
            {brandsAssets.home?.subtitle && (
              <h1 class="text-6xl md:text-9xl italic font-bold " style={`color: white`}>
                {brandsAssets.home?.subtitle}
              </h1>
            )}
          </div>
        )}
          <ProductsCarousel 
            products={products}
            color={'white'}
            autoplay={true}
            speed={4000}
            slidesPerView={3}
            spaceBetween={30}
            loop={true}
            className="max-w-7xl mx-auto mb-8"
          />
        </div>
      </section>
    )}
    <!-- Sección de recetas con carrusel -->
    <section id="recipes" class="w-full py-12" transition:animate="slide">
      <div class="container mx-auto px-4">
        {recipesAssets.home?.title && (
          <div class="text-center mb-4 md:mb-16 relative z-20" >
            <h2 class="text-3xl md:text-4xl italic font-bold mb-4" style={`color: #5B3F2E`}>
              {recipesAssets.home?.title}
            </h2>
            {recipesAssets.home?.subtitle && (
              <h1 class="text-6xl md:text-9xl italic font-bold mb-4" style={`color: #5B3F2E`}>
                {recipesAssets.home?.subtitle}
              </h1>
            )}
          </div>
        )}
        <RecipesCarousel 
          title={recipesAssets.home?.title || 'DESCUBRE NUEVOS SABORES CON NUESTRAS'}
          textButton={recipesAssets.home?.view_more || 'Ver Todas'}
        />
      </div>
    </section>


    <!-- Sección Gallery -->
    <section id="gallery" class="bg-pink w-full py-12" transition:animate="slide">
      <div class="container mx-auto px-4">
        {Array.isArray(galleryAssets.images) && galleryAssets.images.length > 0 && (
          <MasonryGallery 
            items={galleryAssets.images}
            columns={3}
            title={galleryAssets.title}
            className=""
          />
        )}
      </div>
    </section>




    <!-- Sección News -->

 <section id="news" class="bg-yellow w-full py-12 " transition:animate="slide">
  <div class="container mx-auto px-4">
    {newsAssets.home.title && (
      <div class="text-center mb-16 relative z-20 overflow-hidden" >
          <div class="absolute left-0 top-0 w-[100%] h-[100%] -z-10 pointer-events-none -ml-[250px]">
            <PixelGrid
               pixelSize={20}
               density={0.7}
               introDuration={800}
               loopInterval={1100}
               mutateAmount={50}
             />
          </div>
        <h2 class="text-3xl md:text-4xl italic font-bold mb-4 text-brown relative z-10">
          {newsAssets.home.title}
        </h2>
        {newsAssets.home.subtitle && (
          <h1 class="text-6xl md:text-9xl italic font-bold mb-4 text-brown relative z-10 flex items-center justify-center">
            
            <span class="font-title pl-2 relative z-10">{newsAssets.home.subtitle}</span>
          </h1>

          
        )}
      </div>


      <!-- botón Suscríbete -->
    <div class="flex justify-center w-full mt-8">
      <a 
        href="https://www.snacksyummies.com/es/yummiesone" 
        class="px-8 py-3 text-white font-bold text-lg rounded-lg hover:opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg inline-block"
        style="background-color: #5b3f2e;" 
        target="_blank" 
        rel="noopener noreferrer">Sub</a>   <!-- pendiente -->
    </div>
    )}

    {latestBlogPosts.length === 0 ? (
      <div class="max-w-5xl mx-auto text-center py-12">
        <p class="text-brown text-lg md:text-xl font-semibold">{noNewsText}</p>
      </div>
    ) : (
      <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-10 items-start">
          <!-- Columna izquierda: 3 más recientes -->
          <div class="md:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-brown font-title text-lg md:text-xl font-bold uppercase tracking-wide">{topNewsLabel}</h3>
              <div class="flex-1 ml-4 border-b border-brown/40"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              {latestBlogPosts.slice(0,3).map((post) => (
                <a
                  href={`/${currentLang}/blog/${post.slug || post.id}`}
                  class="block group relative overflow-hidden rounded-[1.5rem] bg-black/10"
                  style="aspect-ratio: 3/4;"
                >
                  <img
                    src={post.image || '/images/blog/placeholder.jpg'}
                    alt={post.title}
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 ease-out group-hover:scale-105"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-black/10"></div>
                  <div class="absolute inset-x-0 bottom-0 p-5">
                    {post.published_date && (
                      <p class="text-white/80 text-xs md:text-sm mb-1">{post.published_date}</p>
                    )}
                    <h4 class="text-white font-bold text-sm md:text-base leading-tight">{post.title}</h4>
                  </div>
                </a>
              ))}
            </div>
          </div>

          <!-- Columna derecha: destacados (posiciones 3 y 4) -->
          <div class="md:col-span-1">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-brown font-title text-lg md:text-xl font-bold uppercase tracking-wide">{featuredLabel}</h3>
              <div class="flex-1 ml-4 border-b border-brown/40"></div>
            </div>
            <div class="bg-yellow/0">
              <p class="text-brown font-bold text-sm md:text-base leading-snug mb-4">
                {newsAssets?.meta?.descriptiondestacados || (currentLang === 'es'
                  ? 'Sé el primero en conocer nuestras promociones, lanzamientos y más.'
                  : 'Be the first to know about our promotions, launches and more.')}
              </p>
              <a
                href="https://www.snacksyummies.com/es/yummiesone"
                class="inline-flex items-center justify-center w-full border-2 border-brown text-brown py-3 px-6 rounded-full text-center text-sm md:text-base font-bold hover:bg-brown hover:text-white transition-colors mb-6"
              >
                {currentLang === 'es' ? 'QUIERO SUSCRIBIRME' : 'SUBSCRIBE'}
              </a>

              <div class="grid grid-cols-1 gap-4">
                {latestBlogPosts.slice(3,5).map((post) => (
                  <a
                    href={`/${currentLang}/blog/${post.slug || post.id}`}
                    class="flex items-center gap-4 rounded-[1.25rem] bg-white/35 hover:bg-white/50 transition-colors p-3"
                  >
                    <img
                      src={post.image || '/images/blog/placeholder.jpg'}
                      alt={post.title}
                      class="w-20 h-20 object-cover rounded-[1rem] flex-shrink-0"
                      loading="lazy"
                    />
                    <div class="min-w-0">
                      {post.published_date && (
                        <p class="text-brown/70 text-xs md:text-sm mb-1">{post.published_date}</p>
                      )}
                      <p class="text-brown font-bold text-sm md:text-base leading-snug line-clamp-3">{post.title}</p>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-10">
          <a href={`/${currentLang}/blog`} class="border-2 border-brown text-brown py-2 px-8 rounded-full text-center text-sm md:text-base font-medium hover:bg-brown hover:text-white transition-colors">
            {currentLang==='es' ? 'Ver más' : 'View more'}
          </a>
        </div>
      </div>
    )}
  </div>
</section> 

    <!-- Sección Abaout -->
     <!--
<section id="about" class="bg-red w-full py-12" transition:animate="slide">
  <div class="container mx-auto px-4">
    <div class="text-center mb-8">
      {aboutAssets.title && (
        <div class="text-center mb-16 relative z-20" >
          <h2 class="text-3xl md:text-4xl italic font-bold mb-4 text-white">
            {aboutAssets.title}
          </h2>
          {aboutAssets.subtitle && (
            <h1 class="text-6xl md:text-9xl italic font-bold mb-4 text-white">
              {aboutAssets.subtitle}
            </h1>
          )}
        </div>
      )}
    </div>
    <div class="flex flex-col md:flex-row items-center justify-center gap-8">
      <div>
        <h4 class="md:text-4xl text-lg font-bold text-white font-title">LOREM IPSUM DOLOR</h4>
        <p class="text-white font-sans  text-xl leading-relaxed w-100%">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec metus vel ante bibendum finibus. Nullam nec metus vel ante bibendum finibus.</p>
      </div>
      <div>
        <LazyImage src="https://snack.yummiespromociones.com/zibas/gallery16.webp" class="py-4" alt="Ziba's" />
      </div>
      <div>
        <LazyImage src="https://snack.yummiespromociones.com/zibas/gallery15.webp" class="py-4" alt="Ziba's" />
        <h4 class="md:text-4xl text-lg font-bold text-white font-title">LOREM IPSUM DOLOR</h4>
        <p class="text-white font-sans text-xl  leading-relaxed w-100%">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec metus vel ante bibendum finibus. Nullam nec metus vel ante bibendum finibus.</p>
      </div>
    </div>
  </div>
</section> 
-->




  </main>
