---
// src/views/Recipes/Detail/index.astro
import { getLocale } from '../../../i18n/i18n';
import './styles.css';
import RecipeCard from '../../../components/recipes/RecipeCard.astro';
import RelatedRecipesCarousel from '../../../components/recipes/RelatedRecipesCarousel.astro';
import Breadcrumb from '../../../components/common/Breadcrumb/Breadcrumb.astro';
import LazyImage from '../../../components/common/LazyImage.astro';
import { div } from 'framer-motion/m';
import IngredientsCarousel from '../../../components/recipes/IngredientsCarousel.astro';
import ShareModal from '../../../components/common/ShareModal.astro';

interface RecipeItem {
  id: string;
  title: string;
  description: string;
  ingredients: string[];
  instructions: string[];
  preparation_time: number;
  servings: number;
  image?: string;
  tags?: string[];
  product_image?: string;
}

const { currentLang, recipeId } = Astro.props;

// Import all recipe files with static glob and filter by language
const recipeModules = import.meta.glob<{ default: RecipeItem }>("../../../locales/*/recipes/*.json");
const allRecipes: RecipeItem[] = [];
for (const path in recipeModules) {
  const lang = path.split('/') [4];
  if (lang === currentLang) {
    const mod = await recipeModules[path]();
    allRecipes.push(mod.default);
  }
}

// Find current recipe
const recipe = allRecipes.find((item: RecipeItem) => item.id === recipeId);

// Get related recipes (filter current and limit to 3)
const relatedRecipes = allRecipes
  .filter((item: RecipeItem) => item.id !== recipeId)
  .slice(0, 3);

if (!recipe) {
  throw new Error(`Recipe with id ${recipeId} not found`);
}

// Load shared recipe assets (titles, labels etc)
const recipesAssets = {
  recipes: currentLang === 'es' ? 'Ingredientes' : 'Ingredients',
  preparation: currentLang === 'es' ? 'Preparación' : 'Preparation',
  related_recipes: currentLang === 'es' ? 'Recetas relacionadas' : 'Related recipes'
};

function formatTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  
  if (currentLang === 'es') {
    return hours > 0 
      ? `${hours}h ${mins}min` 
      : `${mins}min`;
  } else {
    return hours > 0 
      ? `${hours}h ${mins}m` 
      : `${mins}m`;
  }
}
---
<div style="background-image: url('https://snack.yummiespromociones.com/SnacksyummiesAssets/bgcontactzibas.webp'); background-size: cover; background-position: center; background-repeat: no-repeat;" class="pb-0 overflow-hidden">
  <div class="w-full max-w-6xl mx-auto px-4 pt-4">
    <Breadcrumb 
    bgColor="bg-transparent" textColor="text-white" hoverColor="hover:text-white" />
  </div>
<section id="hero" class="flex flex-col pt-8 md:pt-12 md:flex-row justify-center items-center  pb-8" transition:animate="slide">
  <div class="w-full max-w-6xl flex flex-col md:flex-row items-center justify-center gap-8">
    <div class="w-[80%] md:w-1/2 flex flex-col gap-4 md:p-8 p-4 rounded-lg">
      <h1 class=" font-title md:text-6xl text-5xl font-bold text-white mb-2 text-center md:text-left uppercase italic">{recipe.title}</h1>
      <div class="flex items-center justify-center md:justify-start">
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          class="h-5 w-5 md:h-6 md:w-6 text-white" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor"
        >
          <path 
            stroke-linecap="round" 
            stroke-linejoin="round" 
            stroke-width="2" 
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" 
          />
        </svg>
        <span class="ml-2 md:ml-5 text-white font-title text-base md:text-xl">
          {formatTime(recipe.preparation_time)}
        </span>
      </div>

      <!-- Share button opens modal -->
      <div class="mt-3 md:mt-4">
        <button type="button" class="flex items-center gap-2 bg-white text-primary font-bold px-4 py-2 rounded-full hover:opacity-90 transition" onclick="window.showShareModal && window.showShareModal('shareModal-recipe')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 8a3 3 0 1 0-2.83-4H15a3 3 0 0 0 0 6c.38 0 .74-.07 1.07-.21l-6.1 3.05a3 3 0 1 0 0 2.32l6.1 3.05A3 3 0 1 0 18 16a2.99 2.99 0 0 0-2.93 2.41l-6.1-3.05A3 3 0 0 0 6 12c0-.86.36-1.64.94-2.19l6.13-3.07C13.03 6.5 14 7 15 7c.38 0 .74-.07 1.07-.21C16.39 6.93 17.17 7 18 7z"/>
          </svg>
          {currentLang === 'es' ? 'Compartir' : 'Share'}
        </button>
      </div>
    </div>
   {recipe.image && (
      <div class="w-full md:w-1/2 flex justify-center">
        <div class="relative rounded-2xl overflow-hidden h-80 lg:h-96 w-80 max-w-lg">
          <LazyImage
            src={recipe.image} 
            alt={recipe.title}
            class="w-full h-full object-cover"
            onerror="this.onerror=null;this.src='/images/recipes/placeholder.jpg';"
            transition:name={`recipe-image-${recipe.id}`}
          />
        </div>
      </div>
    )}
    

  </div>
</section>

<section id="ingredients" class=" flex flex-col justify-center items-center    mb-4 py-4 ">
  <div class="w-full max-w-6xl px-4">
    <h2 class="font-title font-bold md:text-4xl text-2xl text-white text-left  uppercase italic ">
      {recipesAssets.recipes}
    </h2>
    
    <div class="flex flex-col md:flex-row items-center justify-center gap-8">
      <!-- {recipe.image && (
        <div class="w-full md:w-1/2 flex justify-center">
          <div class="relative rounded-lg overflow-hidden h-80 lg:h-96 w-80 max-w-lg">
            <img 
              src={recipe.product_image} 
              alt={recipe.title}
              class="w-full h-full object-cover"
              onerror="this.onerror=null;this.src='/images/recipes/placeholder.jpg';"
            />
          </div>
        </div>
      )} -->
      
      <div class="w-full md:w-full flex flex-col gap-4 md:p-8 p-4 rounded-lg text-white">
       
        <section class="mb-8 text-white">
          <IngredientsCarousel items={recipe.ingredients.map((txt: string) => ({ text: txt }))} />
        </section>
      </div>
    </div>
  </div>
</section>

<section id="instructions" class=" flex flex-col justify-center items-center    mb-8  -mt-[1rem] ">

  <div class="w-full max-w-6xl flex flex-col md:flex-row items-center justify-center gap-8">
    <div class="w-full max-w-6xl px-4">
      <h2 class="font-title font-bold md:text-4xl text-2xl text-white text-left mb-8 uppercase italic ">
        {recipesAssets.preparation}
      </h2>
      <section class="mb-8 text-white">
        <ul class="list-disc list-inside space-y-2 text-white">
          {recipe.instructions.map((instruction: string) => (
            <li class="text-white text-lg">
              {instruction}
            </li>
          ))}
        </ul>
      </section>
    </div>
  </div>
</section>
<div id="suggestions_related" class="mt-[-2rem] flex flex-col justify-center items-center pt-12 pb-16 " transition:animate="fade">
  <div class="w-full max-w-6xl px-4">
    <h2 class="text-3xl md:text-6xl font-bold text-white mb-8 text-center font-title italic">
      {currentLang === 'es' ? 'DESCUBRE MÁS RECETAS' : 'Discover More Recipes'}
    </h2>
    <h2 class="pb-8 text-3xl md:text-9xl font-bold text-white mb-8 text-center font-title italic">
      {currentLang === 'es' ? 'SIMILARES' : 'SIMILAR'}
    </h2>
    <!-- Carousel reutilizable con la lista de recetas sugeridas (usa RecipeCard) -->
    <div class="w-full">
      {relatedRecipes.length > 0 && (
        <RelatedRecipesCarousel items={relatedRecipes} />
      )}
    </div>
  </div>
</div>


<!-- Close background wrapper -->
</div>

<script>
  // Este script se ejecuta solo en el navegador
  document.addEventListener('DOMContentLoaded', () => {
    // Manejo de imágenes que fallan al cargar
    document.querySelectorAll('.recipe-detail img').forEach(img => {
      if (!img.hasAttribute('onerror')) {
        img.addEventListener('error', function(this: HTMLImageElement) {
          this.onerror = null;
          this.src = '/images/recipes/placeholder.jpg';
        });
      }
    });
  });
</script>

<!-- Share Modal instance -->
<ShareModal
  id="shareModal-recipe"
  url={Astro.url.href}
  title={recipe.title}
  description={recipe.description}
  hashtags={recipe.tags || []}
  showLabels={false}
  iconSize={40}
  round={true}
  openTextEs="Comparte esta receta en tus redes sociales"
  openTextEn="Share this recipe on your social networks"
  acceptTextEs="Aceptar"
  acceptTextEn="Accept"
/>
